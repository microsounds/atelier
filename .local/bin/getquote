#!/usr/bin/env sh

## getquote v0.2
## (c) 2023 microsounds <https://github.com/microsounds>, GPLv3+
# scrapes Yahoo! Finance API for stock, crypto and ETF price quotes
# outputs as ledger-cli commodity price history format in US Dollars
# format: 'P YYYY/MM/DD HH:MM:SS SYMBOL $USD_PRICE'

## usage: getquote [SYMBOL(s)...]
## typical usage: ledger -f ledger.dat commodities | xargs getquote >> price.db

[ ! -z "$1" ] || {
	cat "$0" | grep '^##' | sed 's/^## //g' 1>&2
	exit 1
}

# 06/2023: yahoo discontinued batch quote json endpoint, one query per symbol
UA_STR='Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Mobile Safari/537.36'
QUOTE_API='https://query1.finance.yahoo.com/v7/finance/options'

for SYM in "$@"; do
	wget -q -U "$UA_STR" -O - "${QUOTE_API}/${SYM}" \
		| jq -r '.optionChain.result[].quote | [.regularMarketPrice,.regularMarketTime] | join(" ")' \
		| while read -r PRICE DATE; do
			printf "%s\r" "Fetching $SYM..." 1>&2
			# quotes are probably time delayed by 15 minutes
			printf 'P %s %s %s\n' \
				"$(date -d "1970-01-01 UTC $DATE seconds" '+%Y/%-m/%-d %H:%M:%S')" \
				"$(echo $SYM | tr 'a-z' 'A-Z')" \
				"\$$PRICE"
	done
done
