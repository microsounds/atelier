#!/usr/bin/env sh
## ~/.local/bin/mpv: mpv 0.29.x dynamic configuration

CONFIG="$HOME/.config/mpv/mpv.conf"
mkdir -p "${CONFIG%/*}"
rm -f "$CONFIG"

# conditional config for specific hardware
unset integrated
for f in $(glxinfo | tr 'A-Z' 'a-z' | egrep '^opengl (vendor|renderer)'); do
	case $f in
		intel) integrated=1; break;;
	esac
done

cat <<- EOF >> "$CONFIG"
	# !!! DO NOT EDIT THIS FILE, SEE ~${0#$HOME} !!!

	# display
	video-sync=display-resample
	scale=ewa_lanczossoft
	cscale=ewa_lanczossoft

	# screenshots
	screenshot-format=png
	screenshot-high-bit-depth=yes
	screenshot-png-compression=9

	# options for anime with multiple audio tracks
	alang=jp,jpn,japanese,en,eng,english
	# prefer subtitle track 2 which are usually full eng subtitles
	slang=en,eng,english
	sid=2

EOF

if [ ! -z "$integrated" ]; then
	cat <<- EOF >> "$CONFIG"
		# force software rendering
		vo=sdl
	EOF
else
	cat <<- EOF >> "$CONFIG"
		# assume decent GPU exists
		profile=gpu-hq
		hwdec=auto
	EOF
fi

exec /usr/bin/mpv "$@"
