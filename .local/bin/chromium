#!/usr/bin/env sh

# chromium persistent configuration overlay script

# DO NOT mangle config if chromium is running
CONF="$HOME/.config/chromium"
is_running() {
	ps -e | fgrep -q 'chromium'
}

if ! is_running; then
	# on first-run, regenerate chromium config
	if [ ! -d "$CONF/Default" ]; then
		# checkout persistent settings if deleted
		git meta checkout "$CONF"

		# warn user of first run
		# allow first run to generate default preferences
		# implicitly enable use of theme colors
		cat <<- EOF | /usr/bin/chromium "data:text/html;base64,$(base64 -w 0)" \
			--install-autogenerated-theme='0,0,0' -incognito &
			<style>
				html { color: #FFFFFF; background: #222222; }
				.note { text-align: center; }
			</style>
			<div class="note">
				<h1>Regenerating <code>chromium</code>
					preferences on first run...</h1>
				<p>This only needs to be done once.</p>
				<p><b>DO NOT</b> interact with this window,
					<code>chromium</code> will restart momentarily.</p>
			</div>
		EOF
		sleep 5 && kill "$!"
	fi

	# inject persistent settings into chromium's JSON config
	for f in 'Default/Preferences' 'Local State'; do
		mine="$(echo "${f#*/}" | tr ' A-Z' '_a-z').conf"
		[ -f "$CONF/$f" ] || continue
		[ -f "$CONF/$mine" ] || continue

		# pipe multiple jq filters together
		# remove trailing newline
		IFS='
		'
		unset json hex
		for g in $(cpp -P < "$CONF/$mine" 2> /dev/null); do
			json="${json}.$g|"
		done
		json="${json%|}"
		unset IFS

		# rewrite #RRGGBB hex colors to signed integer representing 0xBBGGRRAA
		# in two's complement hexadecimal with alpha channel always 0xFF
		for g in $(echo "$json" | egrep -o '\#[A-Fa-f0-9]{6}'); do
			for h in FF $(echo "$g" | tr -d '#' | sed -E 's/.{2}/& /g'); do
				hex="$h$hex"
			done
			int="$(echo "0x$hex" | xxd -r | od -A n -t dI | tr -d ' ')"
			json="$(echo "$json" | sed "s/$g/$int/g")"
		done

		jq -Mc "$json" < "$CONF/$f" > "$CONF/$f.1" && \
			mv "$CONF/$f.1" "$CONF/$f"
	done
fi

# redirect cache writes to ramdisk
/usr/bin/chromium --disk-cache-dir="$XDG_CACHE_HOME/${0##*/}" "$@"
